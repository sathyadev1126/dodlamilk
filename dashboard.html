<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard — Stock, Sales & Remaining (with Day Calendar)</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280}
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:12px;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 4px 18px rgba(16,24,40,.06);margin-top:12px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sectionTitle{font-weight:700;margin-top:8px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  th{background:#fafafa;font-weight:600}
  .big{font-size:18px;font-weight:700}
  .btn{padding:8px 10px;border-radius:8px;border:0;background:#0b74ff;color:#fff;cursor:pointer}
  .btn.ghost{background:#fff;color:#0b74ff;border:1px solid #dbeafe}
  .btn.warn{background:#ffb020;color:#fff}
  .btn.danger{background:#ff4d4f;color:#fff}
  .mutedSmall{font-size:13px;color:#555}
  .low1{background:linear-gradient(90deg,rgba(255,235,205,.4),transparent)}
  .low2{background:linear-gradient(90deg,rgba(255,205,210,.45),transparent)}
  .inline{display:inline-flex;align-items:center;gap:6px}
  .right{margin-left:auto}
  input[type=date]{padding:6px;border-radius:6px;border:1px solid #ddd}
  select, input[type=number], input[type=text]{padding:6px;border-radius:6px;border:1px solid #ddd}
  .small{font-size:12px;padding:6px 8px;border-radius:6px}
  .notice{font-size:12px;color:#6b7280;margin-top:8px}
  .flexcol{display:flex;flex-direction:column;gap:8px}
  @media(max-width:900px){ .two{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Dashboard — Stock & Sales</h1>
      <div class="muted">Live view: Received (morning), Sales (today), Remaining. Uses local storage. Choose Catalog view or a specific day.</div>
    </div>

    <div class="inline">
      <a href="catalog.html" class="btn">Catalog</a>
      <a href="cart.html" class="btn btn ghost">Cart</a>
      <a href="sales.html" class="btn btn ghost">Sales</a>
    </div>
  </header>

  <div class="card controls">
    <div class="inline">
      <label class="mutedSmall">Low-stock threshold:</label>
      <input id="lowThreshold" type="number" value="5" style="width:80px" />
    </div>

    <div class="inline">
      <label class="mutedSmall">Sort by remaining:</label>
      <select id="sortDir">
        <option value="asc">Ascending (lowest first)</option>
        <option value="desc">Descending (highest first)</option>
      </select>
    </div>

    <div class="inline">
      <label class="mutedSmall">View mode:</label>
      <select id="viewMode" title="Choose Catalog (default) or Day view">
        <option value="catalog">Catalog (default)</option>
        <option value="day">Specific day</option>
      </select>
    </div>

    <div class="inline">
      <label class="mutedSmall">Pick day:</label>
      <input id="datePicker" type="date" />
    </div>

    <div class="inline right">
      <button id="downloadTx" class="btn">Download TX (JSON)</button>
      <button id="downloadDayTx" class="btn">Download Day TX</button>
      <button id="exportAllCsv" class="btn btn ghost">Export Products CSV</button>
      <button id="printBtn" class="btn btn ghost">Print / Save PDF</button>
      <button id="clearAll" class="btn danger">Clear All</button>
    </div>

    <div style="width:100%;margin-top:8px" class="flexcol">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="inline"><input id="countsDays" type="number" class="small" value="10" min="1" style="width:72px"/><label class="mutedSmall">days</label></div>
        <button id="showCounts" class="btn small">Show counts (last N days)</button>
        <div style="margin-left:8px" class="inline">
          <label class="mutedSmall">Range start</label>
          <input id="rangeStart" type="date" class="small"/>
          <label class="mutedSmall">end</label>
          <input id="rangeEnd" type="date" class="small"/>
          <button id="exportRangeJson" class="btn small">Export Range JSON</button>
          <button id="exportRangeCsv" class="btn small btn ghost">Export Range CSV</button>
        </div>
        <div style="margin-left:auto" class="inline">
          <button id="backupNow" class="btn small">Backup Now (download)</button>
          <label style="margin-left:6px;" class="mutedSmall">Auto-backup</label>
          <input id="autoBackupToggle" type="checkbox" title="Store daily backup in localStorage (uses space)" />
        </div>
      </div>
      <div id="countsOutput" class="notice"></div>
    </div>
  </div>

  <div class="two">
    <div class="card">
      <div class="muted">Primary view</div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="big" id="todayTotal">₹0</div>
        <div class="mutedSmall" id="todayMeta"></div>
      </div>

      <div class="sectionTitle">Summary</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
        <div class="card" style="padding:8px"><div class="mutedSmall">Received</div><div id="todayReceivedVal" class="big">0</div></div>
        <div class="card" style="padding:8px"><div class="mutedSmall">Sold</div><div id="todaySoldVal" class="big">0</div></div>
        <div class="card" style="padding:8px"><div class="mutedSmall">Remaining</div><div id="todayRemainingVal" class="big">0</div></div>
      </div>

      <div class="sectionTitle">Details</div>
      <div id="todayDetails" class="mutedSmall" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="muted">Previous (backup view)</div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="big" id="yTotal">₹0</div>
        <div class="mutedSmall" id="yMeta"></div>
      </div>

      <div class="sectionTitle">Summary</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
        <div class="card" style="padding:8px"><div class="mutedSmall">Received</div><div id="yReceivedVal" class="big">0</div></div>
        <div class="card" style="padding:8px"><div class="mutedSmall">Sold</div><div id="ySoldVal" class="big">0</div></div>
        <div class="card" style="padding:8px"><div class="mutedSmall">Remaining</div><div id="yRemainingVal" class="big">0</div></div>
      </div>

      <div class="sectionTitle">Details</div>
      <div id="yDetails" class="mutedSmall" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card">
    <div class="sectionTitle">Products — Morning Received / Today Sales / Remaining</div>
    <div style="margin-top:8px" class="mutedSmall">Shows all products for the chosen view. Rows color when remaining ≤ threshold.</div>

    <table id="stockTable" aria-label="stock table">
      <thead>
        <tr><th>Product</th><th>Morning Received</th><th>Today Sales</th><th>Remaining</th><th>Unit ₹</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
(function(){
  // Keys used by other pages
  const TX_KEY = 'milk_tx_v1';
  const PROD_KEY = 'milk_products_v1';
  const CATALOG_ORDER_KEY = 'milk_catalog_order_v1';
  const CART_KEY = 'milk_cart_v1';
  const SELECTED_DATE_KEY = 'milk_selected_date_v1';
  const BACKUP_PREFIX = 'milk_backup_'; // stored as milk_backup_YYYY-MM-DD

  const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('milkshop_channel') : null;

  // Utilities
  function readJSON(key){ try { return JSON.parse(localStorage.getItem(key) || 'null'); } catch(e){ return null; } }
  function readTx(){ return JSON.parse(localStorage.getItem(TX_KEY) || '[]'); }
  function readProducts(){ return JSON.parse(localStorage.getItem(PROD_KEY) || '[]'); }
  function readCatalogOrder(){ return JSON.parse(localStorage.getItem(CATALOG_ORDER_KEY) || '[]'); }

  // Robust date normalizer -> returns 'YYYY-MM-DD' or null
  function txDateString(t){
    if(!t) return null;
    if(t.date && typeof t.date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(t.date)) return t.date;
    const cand = [t.ts, t.time, t.timestamp, t.t, t.createdAt, t.created_at, t.created, t.createdOn, t.date];
    for(const v of cand){
      if(v === undefined || v === null) continue;
      if(typeof v === 'number' || (/^\d+$/.test(String(v)))){
        const n = Number(v);
        if(!isNaN(n)){
          const date = new Date(n > 1e12 ? n : n * 1000);
          if(!isNaN(date.getTime())) return date.toISOString().slice(0,10);
        }
      }
      try {
        const date = new Date(v);
        if(!isNaN(date.getTime())) return date.toISOString().slice(0,10);
      } catch(e){}
    }
    try {
      const s = JSON.stringify(t);
      const m = s.match(/\d{4}-\d{2}-\d{2}/);
      if(m) return m[0];
    } catch(e){}
    return null;
  }

  // Summaries
  function summarizeForCatalog(catalogId){
    const tx = readTx();
    const rec = {}; const sold = {}; let recValue=0, soldValue=0;
    tx.forEach(t=>{
      if((t.catalogId || '') !== (catalogId || '')) return;
      const name = t.name || '—';
      const qty = Number(t.qty || 0);
      const price = Number(t.price || 0);
      if(t.sale){
        sold[name] = (sold[name] || 0) + qty;
        soldValue += qty * price;
      } else {
        rec[name] = (rec[name] || 0) + qty;
        recValue += qty * price;
      }
    });
    return { rec, sold, recValue, soldValue };
  }

  function summarizeForDate(dateStr){
    const tx = readTx();
    const rec = {}; const sold = {}; let recValue=0, soldValue=0;
    tx.forEach(t=>{
      const d = txDateString(t);
      if(d !== dateStr) return;
      const name = t.name || '—';
      const qty = Number(t.qty || 0);
      const price = Number(t.price || 0);
      if(t.sale){
        sold[name] = (sold[name] || 0) + qty;
        soldValue += qty * price;
      } else {
        rec[name] = (rec[name] || 0) + qty;
        recValue += qty * price;
      }
    });
    return { rec, sold, recValue, soldValue };
  }

  // Build product rows
  function buildProductRows(filterVal, filterType){
    const out = (filterType === 'date') ? summarizeForDate(filterVal || '') : summarizeForCatalog(filterVal || '');
    const rec = out.rec || {};
    const sold = out.sold || {};
    const prodList = readProducts() || [];
    const priceMap = {};
    prodList.forEach(p => { if(p && p.name) priceMap[p.name] = Number(p.price || 0); });

    const names = new Set([...Object.keys(rec), ...Object.keys(sold), ...Object.keys(priceMap)]);
    const rows = [];
    names.forEach(n => {
      const r = rec[n] || 0;
      const s = sold[n] || 0;
      const price = priceMap[n] !== undefined ? priceMap[n] : 0;
      rows.push({ name: n, received: r, sold: s, remaining: r - s, price });
    });
    return rows;
  }

  // Render functions
  function renderSummaryPanel(filterVal, filterType, prefix){
    const out = (filterType === 'date') ? summarizeForDate(filterVal || '') : summarizeForCatalog(filterVal || '');
    const recTotal = Object.values(out.rec || {}).reduce((a,b)=>a+b,0);
    const soldTotal = Object.values(out.sold || {}).reduce((a,b)=>a+b,0);
    const remainingTotal = recTotal - soldTotal;
    document.getElementById(prefix + 'ReceivedVal').textContent = recTotal;
    document.getElementById(prefix + 'SoldVal').textContent = soldTotal;
    document.getElementById(prefix + 'RemainingVal').textContent = remainingTotal;
    const soldVal = Number(out.soldValue || 0);
    document.getElementById((prefix === 'today' ? 'todayTotal' : 'yTotal')).textContent = '₹' + soldVal.toFixed(2);
    document.getElementById(prefix + 'Details').textContent = ((Object.keys(out.rec || {}).length) || (Object.keys(out.sold || {}).length)) ?
      `Products received: ${Object.keys(out.rec || {}).length}, products sold: ${Object.keys(out.sold || {}).length}` : 'No transactions';
  }

  function renderStockTable(){
    const order = readCatalogOrder() || [];
    const viewMode = document.getElementById('viewMode').value || 'catalog';
    let filterType = 'catalog';
    let filterVal = order[0] || null;

    if(viewMode === 'day'){
      filterType = 'date';
      filterVal = localStorage.getItem(SELECTED_DATE_KEY) || document.getElementById('datePicker').value || null;
    }

    const rows = buildProductRows(filterVal, filterType);
    const tbody = document.querySelector('#stockTable tbody');
    tbody.innerHTML = '';

    const threshold = Number(document.getElementById('lowThreshold').value || 0);
    const sortDir = document.getElementById('sortDir').value || 'asc';

    rows.sort((a,b) => {
      if(sortDir === 'asc') return a.remaining - b.remaining || a.name.localeCompare(b.name);
      return b.remaining - a.remaining || a.name.localeCompare(b.name);
    });

    rows.forEach(r => {
      const tr = document.createElement('tr');
      if(r.remaining <= 0) tr.className = 'low2';
      else if(r.remaining <= threshold) tr.className = 'low1';
      tr.innerHTML = `\n        <td>${r.name}</td>\n        <td>${r.received}</td>\n        <td>${r.sold}</td>\n        <td>${r.remaining < 0 ? r.remaining + ' (oversold)' : r.remaining}</td>\n        <td>₹${Number(r.price||0).toFixed(2)}</td>\n      `;
      tbody.appendChild(tr);
    });

    const totalRec = rows.reduce((s,x)=>s + (x.received||0),0);
    const totalSold = rows.reduce((s,x)=>s + (x.sold||0),0);
    const totalRem = rows.reduce((s,x)=>s + (x.remaining||0),0);

    document.getElementById('todayReceivedVal').textContent = totalRec;
    document.getElementById('todaySoldVal').textContent = totalSold;
    document.getElementById('todayRemainingVal').textContent = totalRem;

    if(filterType === 'date'){
      document.getElementById('todayMeta').textContent = filterVal ? `Day: ${filterVal}` : 'No day selected';
    } else {
      document.getElementById('todayMeta').textContent = filterVal ? `Catalog: ${filterVal}` : 'No active catalog';
    }
  }

  function renderAll(){
    const order = readCatalogOrder() || [];
    const todayId = order[0] || null;
    const yesterdayId = order[1] || null;

    document.getElementById('yMeta').textContent = yesterdayId ? `Catalog: ${yesterdayId}` : 'No previous catalog';

    const viewMode = document.getElementById('viewMode').value || 'catalog';
    if(viewMode === 'day'){
      const selectedDate = localStorage.getItem(SELECTED_DATE_KEY) || document.getElementById('datePicker').value || '';
      renderSummaryPanel(selectedDate, 'date', 'today');
      renderSummaryPanel(yesterdayId, 'catalog', 'y');
    } else {
      renderSummaryPanel(todayId, 'catalog', 'today');
      renderSummaryPanel(yesterdayId, 'catalog', 'y');
    }

    renderStockTable();

    function topItemsFor(filterVal, filterType){
      const rows = buildProductRows(filterVal || '', filterType || 'catalog');
      const sold = rows.filter(r=>r.sold>0).sort((a,b)=>b.sold - a.sold).slice(0,6);
      return sold.length ? sold.map(s=>`${s.name}×${s.sold}`).join(' • ') : 'No sales';
    }

    if(viewMode === 'day'){
      const sd = localStorage.getItem(SELECTED_DATE_KEY) || document.getElementById('datePicker').value || '';
      document.getElementById('todayDetails').textContent = 'Top sold: ' + topItemsFor(sd, 'date');
    } else {
      document.getElementById('todayDetails').textContent = 'Top sold: ' + topItemsFor(todayId, 'catalog');
    }

    document.getElementById('yDetails').textContent = 'Top sold: ' + topItemsFor(yesterdayId, 'catalog');
  }

  // Exports
  function downloadJSON(key, filename){
    const data = localStorage.getItem(key) || '[]';
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
  }

  // Download transactions for a single date
  function downloadTxForDate(dateStr){
    if(!dateStr){ alert('No date selected'); return; }
    const tx = readTx();
    const filtered = tx.filter(t => txDateString(t) === dateStr);
    const blob = new Blob([JSON.stringify(filtered, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `milk_tx_${dateStr}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Export range (inclusive)
  function exportRangeToJson(startDateISO, endDateISO){
    if(!startDateISO || !endDateISO){ alert('Pick start and end dates'); return; }
    const tx = readTx();
    const filtered = tx.filter(t=>{
      const d = txDateString(t);
      return d && d >= startDateISO && d <= endDateISO;
    });
    const blob = new Blob([JSON.stringify(filtered, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `milk_tx_${startDateISO}_to_${endDateISO}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportRangeToCsv(startDateISO, endDateISO){
    if(!startDateISO || !endDateISO){ alert('Pick start and end dates'); return; }
    const tx = readTx();
    const rows = tx.filter(t=>{
      const d = txDateString(t);
      return d && d >= startDateISO && d <= endDateISO;
    }).map(t=>{
      return {
        date: txDateString(t) || '',
        name: t.name||'',
        qty: t.qty||0,
        price: t.price||0,
        sale: t.sale?1:0
      };
    });
    if(!rows.length){ alert('No records in range'); return; }
    const cols = Object.keys(rows[0]);
    const csv = [cols.join(',')].concat(rows.map(r=> cols.map(c=> `"${String(r[c]).replace(/"/g,'""')}"`).join(',') )).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `milk_tx_${startDateISO}_to_${endDateISO}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  // Counts for last N days
  function countsForLastNDays(n){
    n = Number(n || 10);
    const tx = readTx();
    const out = {};
    for(let i=0;i<n;i++){
      const d = new Date(); d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0,10);
      out[key] = 0;
    }
    tx.forEach(t=>{
      const ds = txDateString(t);
      if(ds && out.hasOwnProperty(ds)) out[ds] = out[ds] + 1;
    });
    return out;
  }

  // Simple backup: download full txs now
  function backupNowDownload(){
    const tx = readTx();
    const blob = new Blob([JSON.stringify(tx, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const today = new Date().toISOString().slice(0,10);
    a.download = `milk_tx_full_backup_${today}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Auto-backup: store a copy in localStorage under milk_backup_YYYY-MM-DD
  function autoBackupToday(){
    try {
      const today = new Date().toISOString().slice(0,10);
      const key = BACKUP_PREFIX + today;
      // if exists, keep it (no overwrite) — create once per day
      if(localStorage.getItem(key)) return;
      const tx = localStorage.getItem(TX_KEY) || '[]';
      localStorage.setItem(key, tx);
      // optionally record backups index
      const idx = JSON.parse(localStorage.getItem(BACKUP_PREFIX + 'index') || '[]');
      idx.push({date: today, key: key, createdAt: new Date().toISOString()});
      localStorage.setItem(BACKUP_PREFIX + 'index', JSON.stringify(idx));
    } catch(e){ console.warn('Auto-backup failed', e); }
  }

  // Clear all data
  function clearAll(){
    if(!confirm('Delete all transactions, products and cart from local storage?')) return;
    localStorage.removeItem(TX_KEY);
    localStorage.removeItem(PROD_KEY);
    localStorage.removeItem(CART_KEY);
    localStorage.removeItem(CATALOG_ORDER_KEY);
    if(bc) bc.postMessage({type:'tx-cleared'});
    else localStorage.setItem('milkshop_signal', Date.now().toString());
    renderAll();
  }

  // Hooks / events
  document.getElementById('downloadTx').addEventListener('click', ()=> downloadJSON(TX_KEY, 'milk_tx_v1.json'));
  document.getElementById('downloadDayTx').addEventListener('click', ()=>{
    const dateStr = localStorage.getItem(SELECTED_DATE_KEY) || document.getElementById('datePicker').value || '';
    downloadTxForDate(dateStr);
  });
  document.getElementById('exportAllCsv').addEventListener('click', ()=> {
    // export current view's products CSV (existing behavior)
    const order = readCatalogOrder() || [];
    const viewMode = document.getElementById('viewMode').value || 'catalog';
    let filterType = 'catalog';
    let filterVal = order[0] || '';
    if(viewMode === 'day'){ filterType='date'; filterVal = localStorage.getItem(SELECTED_DATE_KEY) || document.getElementById('datePicker').value || ''; }
    const rows = buildProductRows(filterVal, filterType);
    const cols = ['Product','Received','Sold','Remaining','UnitPrice'];
    const csv = [cols.join(',')].concat(rows.map(r=>{
      return [r.name, r.received, r.sold, r.remaining, Number(r.price||0).toFixed(2)].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
    })).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'product_stock_view.csv'; a.click();
    URL.revokeObjectURL(a.href);
  });
  document.getElementById('printBtn').addEventListener('click', ()=> window.print());
  document.getElementById('clearAll').addEventListener('click', clearAll);

  document.getElementById('lowThreshold').addEventListener('change', renderAll);
  document.getElementById('sortDir').addEventListener('change', renderAll);
  document.getElementById('viewMode').addEventListener('change', ()=>{
    const vm = document.getElementById('viewMode').value;
    if(vm === 'day' && !document.getElementById('datePicker').value){
      const today = new Date();
      const y = today.getFullYear(); const m = String(today.getMonth()+1).padStart(2,'0'); const d = String(today.getDate()).padStart(2,'0');
      document.getElementById('datePicker').value = `${y}-${m}-${d}`;
      localStorage.setItem(SELECTED_DATE_KEY, document.getElementById('datePicker').value);
    }
    localStorage.setItem('milk_view_mode_v1', vm);
    renderAll();
  });

  document.getElementById('datePicker').addEventListener('change', (e)=>{
    const v = e.target.value;
    if(v) localStorage.setItem(SELECTED_DATE_KEY, v);
    renderAll();
  });

  // counts and range exports
  document.getElementById('showCounts').addEventListener('click', ()=>{
    const n = Number(document.getElementById('countsDays').value || 10);
    const out = countsForLastNDays(n);
    const lines = Object.keys(out).map(k=>`${k}: ${out[k]} tx`);
    document.getElementById('countsOutput').textContent = lines.join(' • ');
  });

  document.getElementById('exportRangeJson').addEventListener('click', ()=>{
    const s = document.getElementById('rangeStart').value;
    const e = document.getElementById('rangeEnd').value;
    exportRangeToJson(s, e);
  });
  document.getElementById('exportRangeCsv').addEventListener('click', ()=>{
    const s = document.getElementById('rangeStart').value;
    const e = document.getElementById('rangeEnd').value;
    exportRangeToCsv(s, e);
  });

  document.getElementById('backupNow').addEventListener('click', backupNowDownload);
  document.getElementById('autoBackupToggle').addEventListener('change', (e)=>{
    localStorage.setItem(BACKUP_PREFIX + 'enabled', e.target.checked ? '1' : '0');
    // if enabling now, run today's backup immediately
    if(e.target.checked) autoBackupToday();
  });

  // Live update: BroadcastChannel or storage event fallback
  if(bc){
    bc.onmessage = function(ev){
      const t = ev.data && ev.data.type;
      if(['tx-added','tx-added-batch','products-published','products-cleared','tx-cleared','cart-change'].includes(t)) renderAll();
    };
  } else {
    window.addEventListener('storage', function(e){
      if([TX_KEY, PROD_KEY, CATALOG_ORDER_KEY, 'milkshop_signal', SELECTED_DATE_KEY].includes(e.key)) renderAll();
    });
  }

  // Auto-backup runner: check once per minute whether we need to write today's backup (if enabled)
  setInterval(()=>{
    try {
      const enabled = localStorage.getItem(BACKUP_PREFIX + 'enabled') === '1';
      if(enabled) autoBackupToday();
    } catch(e){}
  }, 60 * 1000);

  // Initial state restore
  (function restore(){
    const savedDate = localStorage.getItem(SELECTED_DATE_KEY);
    if(savedDate) document.getElementById('datePicker').value = savedDate;
    const savedView = localStorage.getItem('milk_view_mode_v1') || 'catalog';
    document.getElementById('viewMode').value = savedView;
    const autoEnabled = localStorage.getItem(BACKUP_PREFIX + 'enabled') === '1';
    document.getElementById('autoBackupToggle').checked = !!autoEnabled;
    renderAll();
    // run auto-backup immediately if enabled
    if(autoEnabled) autoBackupToday();
  })();

  // periodic refresh
  setInterval(renderAll, 1500);

})();
</script>
</body>
</html>
